<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfect Competition | ECON 101H</title>

  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/beamer-theme.css">

  <style>
    /* Page-specific styles can go here */

    /* Market Equilibrium Graph */
    .graph-frame {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: #fdf6e3;
    }

    .graph-frame h2 {
      font-size: 1.8rem;
      margin-bottom: 2rem;
      color: #657b83;
    }

    #equilibrium-graph {
      max-width: 700px;
      width: 100%;
    }

    .axis-line {
      stroke: #586e75;
      stroke-width: 3;
      fill: none;
    }

    .axis-arrow {
      fill: #586e75;
    }

    .axis-label {
      font-family: 'Times New Roman', serif;
      font-size: 24px;
      font-style: italic;
      fill: #586e75;
    }

    .demand-line {
      stroke: #dc322f;
      stroke-width: 5;
      fill: none;
    }

    .supply-line {
      stroke: #268bd2;
      stroke-width: 5;
      fill: none;
    }

    .dotted-line {
      stroke: #586e75;
      stroke-width: 3;
      stroke-dasharray: 8, 6;
      fill: none;
    }

    .eq-label {
      font-family: 'Times New Roman', serif;
      font-size: 20px;
      font-style: italic;
      fill: #586e75;
    }

    .atc-line {
      stroke: #859900;
      stroke-width: 5;
      fill: none;
    }
  </style>
</head>
<body>

  <!-- Title Slide -->
  <section class="title-slide">
    <div class="title-box">
      <h1>Perfect Competition</h1>
      <h2>ECON 101H: Introduction to Economics</h2>
    </div>
    <p class="author">Sérgio O. Parreiras</p>
    <p class="institute">Economics Department, UNC at Chapel Hill</p>
    <p class="date">Spring 2026</p>
  </section>

  <!-- Frame 1: Market Equilibrium -->
  <section class="graph-frame" id="market-equilibrium">
    <svg id="equilibrium-graph" viewBox="-45 -20 585 400">
      <defs>
        <!-- Arrow marker for axes (slimmer) -->
        <marker id="arrowhead" markerWidth="12" markerHeight="5" refX="11" refY="2.5" orient="auto">
          <polygon points="0 0, 12 2.5, 0 5" class="axis-arrow"/>
        </marker>
      </defs>

      <!-- Axes -->
      <!-- Y-axis (P) - extended to P=140 -->
      <line x1="20" y1="350" x2="20" y2="6" class="axis-line" marker-end="url(#arrowhead)"/>
      <!-- X-axis (Q) -->
      <line x1="20" y1="350" x2="495" y2="350" class="axis-line" marker-end="url(#arrowhead)"/>

      <!-- Axis labels -->
      <text x="20" y="-2" text-anchor="middle" class="axis-label">P</text>
      <text x="505" y="355" class="axis-label">Q</text>

      <!-- Demand curve: P = 120 - Q/2 -->
      <!-- At Q=0, P=120; at Q=150, P=45 -->
      <!-- Scale: Q range 0-150 maps to x 20-490 (3.133px per unit) -->
      <!-- Scale: P range 0-140 maps to y 350-6 (2.46px per unit) -->
      <!-- Q=0 -> x=20, P=120 -> y=350-120*2.46=55 -->
      <!-- Q=150 -> x=20+150*3.133=490, P=45 -> y=350-45*2.46=239 -->
      <line id="demand-curve" x1="20" y1="55" x2="490" y2="239" class="demand-line"/>

      <!-- Supply curve: P = 5 + 2Q -->
      <!-- At Q=0, P=5; at Q=67.5, P=140 (top of chart) -->
      <!-- Q=0 -> x=20, P=5 -> y=350-5*2.46=338 -->
      <!-- Q=67.5 -> x=20+67.5*3.133=232, P=140 -> y=350-140*2.46=6 -->
      <line id="supply-curve" x1="20" y1="338" x2="232" y2="6" class="supply-line"/>

      <!-- Equilibrium point: Q*=46, P*=97 -->
      <!-- Q=46 -> x=60+46*4=244 -->
      <!-- P=97 -> y=350-97*2.46=111 -->

      <!-- Dotted line from equilibrium to P-axis (horizontal) -->
      <line id="eq-line-h" x1="244" y1="111" x2="244" y2="111" class="dotted-line"/>

      <!-- Dotted line from equilibrium to Q-axis (vertical) -->
      <line id="eq-line-v" x1="244" y1="111" x2="244" y2="111" class="dotted-line"/>

      <!-- Equilibrium labels (hidden initially) -->
      <!-- Y-axis at x=20, so price label at x=-5 gives 25px spacing (same as Q labels) -->
      <text id="eq-p-label" x="-5" y="116" text-anchor="end" class="eq-label" opacity="0">97</text>
      <text id="eq-q-label" x="236" y="375" class="eq-label" opacity="0">46</text>

      <!-- Curve labels -->
      <text x="455" y="268" class="eq-label" fill="#dc322f">D</text>
      <!-- S label will be created dynamically to follow supply curve -->

      <!-- ATC curve: ATC = 100/Q + 5 + Q -->
      <!-- Min at Q=10 (ATC=25), dATC/dQ = -100/Q^2 + 1 = 0 at Q=10 -->
      <!-- Scale: x = 20 + Q*3.133, y = 350 - ATC*2.46 (P range 0-140) -->
      <!-- Key points (extra detail Q=10-23 for accuracy): -->
      <!-- Q=2: x=26, ATC=57, y=210 -->
      <!-- Q=5: x=36, ATC=30, y=276 -->
      <!-- Q=10: x=51, ATC=25, y=288 (minimum) -->
      <!-- Q=12: x=58, ATC=25.33, y=287 -->
      <!-- Q=14: x=64, ATC=26.14, y=286 -->
      <!-- Q=16: x=70, ATC=27.25, y=283 -->
      <!-- Q=18: x=76, ATC=28.56, y=280 -->
      <!-- Q=20: x=83, ATC=30, y=276 -->
      <!-- Q=23: x=92, ATC=32.35, y=270 -->
      <!-- Q=30: x=114, ATC=38.3, y=256 -->
      <!-- Q=40: x=145, ATC=47.5, y=233 -->
      <!-- Q=50: x=177, ATC=57, y=210 -->
      <!-- Q=60: x=208, ATC=66.7, y=186 -->
      <!-- Q=70: x=239, ATC=76.4, y=162 -->
      <!-- Q=80: x=271, ATC=86.25, y=138 -->
      <!-- Q=90: x=302, ATC=96.1, y=114 -->
      <!-- Q=100: x=333, ATC=106, y=89 -->
      <!-- Q=110: x=365, ATC=115.9, y=65 -->
      <!-- Q=120: x=396, ATC=125.8, y=40 -->
      <!-- Q=125: x=412, ATC=130.8, y=28 (near top) -->
      <path id="atc-curve"
        d="M 26 210
           C 29 250, 36 285, 51 288
           L 58 287
           L 64 286
           L 70 283
           L 76 280
           L 83 276
           L 92 270
           C 103 263, 114 256, 129 245
           C 153 228, 177 210, 208 186
           C 239 162, 271 138, 302 114
           C 317 102, 333 89, 365 65
           C 380 52, 396 40, 412 28"
        class="atc-line" opacity="0"/>

      <!-- ATC label (visible immediately with curve) -->
      <text id="atc-label" x="415" y="20" class="eq-label" fill="#859900">ATC</text>
    </svg>
  </section>



  <!-- KaTeX JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <!-- GSAP + ScrollTrigger -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

  <!-- Custom JS -->
  <script src="js/katex-macros.js"></script>
  <script src="js/scroll-animations.js"></script>

  <!-- Market Equilibrium Animation -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      gsap.registerPlugin(ScrollTrigger);

      // ============================================
      // ECONOMIC FUNCTIONS (change these to update the whole graph)
      // ============================================
      // Demand: P = demandIntercept - demandSlope * Q
      const demandIntercept = 120;
      const demandSlope = 0.5;

      // Supply (MC): P = supplyIntercept + supplySlope * Q
      const supplyIntercept = 5;
      const supplySlope = 2;

      // ATC: ATC = atcFixed/Q + atcConstant + atcLinear*Q
      const atcFixed = 100;
      const atcConstant = 5;
      const atcLinear = 1;

      // ============================================
      // DERIVED VALUES
      // ============================================
      // Equilibrium: demandIntercept - demandSlope*Q = supplyIntercept + supplySlope*Q
      // Q* = (demandIntercept - supplyIntercept) / (demandSlope + supplySlope)
      const Qeq = (demandIntercept - supplyIntercept) / (demandSlope + supplySlope);
      const Peq = supplyIntercept + supplySlope * Qeq;

      // ATC at equilibrium
      const ATCeq = atcFixed / Qeq + atcConstant + atcLinear * Qeq;

      // ============================================
      // COORDINATE CONVERSION
      // ============================================
      // Scale: Q range 0-150 maps to x 20-490 (3.133px per unit)
      // Scale: P range 0-140 maps to y 350-6 (2.46px per unit)
      const xOrigin = 20;
      const yOrigin = 350;
      const xScale = 470 / 150;  // px per Q unit (≈3.133)
      const yScale = 2.46;       // px per P unit

      const toX = (Q) => xOrigin + Q * xScale;
      const toY = (P) => yOrigin - P * yScale;

      // Equilibrium point in SVG coordinates
      const eqX = toX(Qeq);
      const eqY = toY(Peq);

      // ATC at equilibrium in SVG coordinates
      const atcEqY = toY(ATCeq);

      console.log(`Equilibrium: Q*=${Qeq}, P*=${Peq.toFixed(1)}`);
      console.log(`ATC at Q*: ${ATCeq.toFixed(1)}`);
      console.log(`SVG coords: eq=(${eqX}, ${eqY}), atcEq=(${eqX}, ${atcEqY})`);

      // ============================================
      // UPDATE SVG ELEMENTS WITH COMPUTED VALUES
      // ============================================
      // Update equilibrium dotted lines starting positions
      document.getElementById('eq-line-h').setAttribute('x1', eqX);
      document.getElementById('eq-line-h').setAttribute('y1', eqY);
      document.getElementById('eq-line-h').setAttribute('x2', eqX);
      document.getElementById('eq-line-h').setAttribute('y2', eqY);

      document.getElementById('eq-line-v').setAttribute('x1', eqX);
      document.getElementById('eq-line-v').setAttribute('y1', eqY);
      document.getElementById('eq-line-v').setAttribute('x2', eqX);
      document.getElementById('eq-line-v').setAttribute('y2', eqY);

      // Update equilibrium labels
      document.getElementById('eq-p-label').textContent = Math.round(Peq);
      document.getElementById('eq-p-label').setAttribute('y', eqY + 5);
      document.getElementById('eq-q-label').textContent = Math.round(Qeq);
      document.getElementById('eq-q-label').setAttribute('x', eqX - 8);

      // Create ATC horizontal line (from ATC(Q*) to P-axis)
      const atcLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      atcLine.setAttribute('id', 'atc-line-h');
      atcLine.setAttribute('x1', eqX);
      atcLine.setAttribute('y1', atcEqY);
      atcLine.setAttribute('x2', eqX);
      atcLine.setAttribute('y2', atcEqY);
      atcLine.setAttribute('class', 'dotted-line');
      document.getElementById('equilibrium-graph').appendChild(atcLine);

      // Create ATC price label (25px spacing from Y-axis, same as Q labels from X-axis)
      const atcPriceLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      atcPriceLabel.setAttribute('id', 'atc-p-label');
      atcPriceLabel.setAttribute('x', -5);
      atcPriceLabel.setAttribute('y', atcEqY + 5);
      atcPriceLabel.setAttribute('text-anchor', 'end');
      atcPriceLabel.setAttribute('class', 'eq-label');
      atcPriceLabel.setAttribute('opacity', 0);
      atcPriceLabel.textContent = Math.round(ATCeq);
      document.getElementById('equilibrium-graph').appendChild(atcPriceLabel);

      // Create profit rectangle: from (0, P*) to (Q*, ATC(Q*))
      // Rectangle corners: top-left (xOrigin, eqY), bottom-right (eqX, atcEqY)
      const profitRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      profitRect.setAttribute('id', 'profit-rect');
      profitRect.setAttribute('x', xOrigin);
      profitRect.setAttribute('y', eqY);  // P* is higher (lower y value)
      profitRect.setAttribute('width', eqX - xOrigin);
      profitRect.setAttribute('height', atcEqY - eqY);  // from P* down to ATC(Q*)
      profitRect.setAttribute('fill', '#2aa198');  // Solarized cyan
      profitRect.setAttribute('opacity', 0);
      document.getElementById('equilibrium-graph').appendChild(profitRect);

      // Create profit label
      const profitLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      profitLabel.setAttribute('id', 'profit-label');
      profitLabel.setAttribute('x', xOrigin + (eqX - xOrigin) / 2);  // center of rectangle
      profitLabel.setAttribute('y', eqY + (atcEqY - eqY) / 2 + 6);   // center of rectangle
      profitLabel.setAttribute('text-anchor', 'middle');
      profitLabel.setAttribute('class', 'eq-label');
      profitLabel.setAttribute('fill', '#fdf6e3');  // Light text on green
      profitLabel.setAttribute('font-weight', 'bold');
      profitLabel.setAttribute('opacity', 0);
      profitLabel.textContent = 'Profits';
      document.getElementById('equilibrium-graph').appendChild(profitLabel);

      // Create Supply curve label (dynamic, pinned at 80% of visible supply curve, 30px above)
      const supplyLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      supplyLabel.setAttribute('id', 'supply-label');
      const initialSupplyEndQ = 140 / supplySlope;  // Q where P=140
      const supplyStartX = xOrigin;
      const supplyStartY = toY(supplyIntercept);
      const initialSupplyEndX = toX(initialSupplyEndQ);
      const initialSupplyEndY = toY(140);
      const labelX = supplyStartX + 0.8 * (initialSupplyEndX - supplyStartX);
      const labelY = supplyStartY + 0.8 * (initialSupplyEndY - supplyStartY) - 30;
      supplyLabel.setAttribute('x', labelX);
      supplyLabel.setAttribute('y', labelY);
      supplyLabel.setAttribute('class', 'eq-label');
      supplyLabel.setAttribute('fill', '#268bd2');
      supplyLabel.textContent = 'S';
      document.getElementById('equilibrium-graph').appendChild(supplyLabel);

      // ============================================
      // ANIMATION TIMELINE
      // ============================================
      const mainTimeline = gsap.timeline({
        scrollTrigger: {
          trigger: '#market-equilibrium',
          start: 'top top',
          end: '+=680%',         // Adjusted for shorter ATC line animation
          pin: true,
          scrub: 1,
          anticipatePin: 1
        }
      });

      // Phase 1 (0-25%): Equilibrium dotted lines animation
      mainTimeline.to('#eq-line-h', {
        attr: { x2: xOrigin },
        duration: 1,
        ease: 'none'
      }, 0);

      mainTimeline.to('#eq-line-v', {
        attr: { y2: yOrigin },
        duration: 1,
        ease: 'none'
      }, 0);

      mainTimeline.to('#eq-p-label', {
        opacity: 1,
        duration: 0.3,
        ease: 'none'
      }, 0.7);

      mainTimeline.to('#eq-q-label', {
        opacity: 1,
        duration: 0.3,
        ease: 'none'
      }, 0.7);

      // Phase 2 (25-50%): Delay / pause

      // Phase 3 (50-75%): ATC curve draws from left to right
      const atcPath = document.getElementById('atc-curve');
      const atcLength = atcPath.getTotalLength();

      gsap.set('#atc-curve', {
        strokeDasharray: atcLength,
        strokeDashoffset: atcLength,
        opacity: 1
      });

      gsap.set('#atc-label', { opacity: 0 });

      mainTimeline.to('#atc-curve', {
        strokeDashoffset: 0,
        duration: 1,
        ease: 'none'
      }, 2);

      mainTimeline.set('#atc-label', {
        opacity: 1
      }, 3);

      // Phase 4 (75-90%): Horizontal line from (Q*, ATC(Q*)) to P-axis
      mainTimeline.to('#atc-line-h', {
        attr: { x2: xOrigin },
        duration: 0.8,
        ease: 'none'
      }, 3.5);

      // Show ATC price label
      mainTimeline.to('#atc-p-label', {
        opacity: 1,
        duration: 0.3,
        ease: 'none'
      }, 4.0);

      // Phase 5: Profit rectangle fills in
      mainTimeline.to('#profit-rect', {
        opacity: 0.4,
        duration: 1,
        ease: 'none'
      }, 4.3);

      // Profit label appears
      mainTimeline.to('#profit-label', {
        opacity: 1,
        duration: 0.3,
        ease: 'none'
      }, 5.0);

      // Phase 6: Supply curve shifts - k goes from 1 to 0.133
      // P = supplyIntercept + supplySlope * k * Q
      // When k=1: original supply curve (Q*=46, P*=97)
      // When k=0.133: flatter supply curve reaching equilibrium at right edge (Q*=150, P*=45)

      // We need to animate multiple elements simultaneously based on k
      // Use GSAP's onUpdate to recalculate positions as k changes

      const kAnimState = { k: 1 };

      // Function to compute equilibrium for a given k
      function computeEqForK(k) {
        // Supply: P = supplyIntercept + supplySlope * k * Q
        // Demand: P = demandIntercept - demandSlope * Q
        // Equilibrium: demandIntercept - demandSlope * Q = supplyIntercept + supplySlope * k * Q
        // Q* = (demandIntercept - supplyIntercept) / (demandSlope + supplySlope * k)
        const effectiveSupplySlope = supplySlope * k;
        const Q = (demandIntercept - supplyIntercept) / (demandSlope + effectiveSupplySlope);
        const P = supplyIntercept + effectiveSupplySlope * Q;
        const ATC = atcFixed / Q + atcConstant + atcLinear * Q;
        return { Q, P, ATC };
      }

      // Function to update all elements based on k
      function updateForK(k) {
        const eq = computeEqForK(k);
        const newEqX = toX(eq.Q);
        const newEqY = toY(eq.P);
        const newAtcEqY = toY(eq.ATC);

        // Update supply curve endpoints
        // At Q=0, P=supplyIntercept (always)
        // When k>0: find Q where supply reaches top of chart (P=140)
        // When k→0.133: supply extends to Q=150 (right edge) where it meets demand at P=45
        const effectiveSupplySlope = supplySlope * k;
        const maxQ = effectiveSupplySlope > 0.01 ? (140 - supplyIntercept) / effectiveSupplySlope : 150;
        const supplyEndX = toX(Math.min(maxQ, 150));
        const supplyEndY = toY(supplyIntercept + effectiveSupplySlope * Math.min(maxQ, 150));

        document.getElementById('supply-curve').setAttribute('x2', supplyEndX);
        document.getElementById('supply-curve').setAttribute('y2', supplyEndY);

        // Update Supply label position (pinned at 80% of visible supply curve, 30px above)
        const supplyStartX = xOrigin;
        const supplyStartY = toY(supplyIntercept);
        const labelX = supplyStartX + 0.8 * (supplyEndX - supplyStartX);
        const labelY = supplyStartY + 0.8 * (supplyEndY - supplyStartY) - 30;
        document.getElementById('supply-label').setAttribute('x', labelX);
        document.getElementById('supply-label').setAttribute('y', labelY);

        // Update equilibrium horizontal line (from eq point to P-axis)
        document.getElementById('eq-line-h').setAttribute('x1', newEqX);
        document.getElementById('eq-line-h').setAttribute('y1', newEqY);
        document.getElementById('eq-line-h').setAttribute('x2', xOrigin);
        document.getElementById('eq-line-h').setAttribute('y2', newEqY);

        // Update equilibrium vertical line (from eq point to Q-axis)
        document.getElementById('eq-line-v').setAttribute('x1', newEqX);
        document.getElementById('eq-line-v').setAttribute('y1', newEqY);
        document.getElementById('eq-line-v').setAttribute('x2', newEqX);
        document.getElementById('eq-line-v').setAttribute('y2', yOrigin);

        // Update equilibrium labels
        document.getElementById('eq-p-label').textContent = Math.round(eq.P);
        document.getElementById('eq-p-label').setAttribute('y', newEqY + 5);
        document.getElementById('eq-q-label').textContent = Math.round(eq.Q);
        document.getElementById('eq-q-label').setAttribute('x', newEqX - 8);

        // Update ATC horizontal line
        document.getElementById('atc-line-h').setAttribute('x1', newEqX);
        document.getElementById('atc-line-h').setAttribute('y1', newAtcEqY);
        document.getElementById('atc-line-h').setAttribute('x2', xOrigin);
        document.getElementById('atc-line-h').setAttribute('y2', newAtcEqY);

        // Update ATC price label
        document.getElementById('atc-p-label').textContent = Math.round(eq.ATC);
        document.getElementById('atc-p-label').setAttribute('y', newAtcEqY + 5);

        // Update profit/loss rectangle
        const isProfit = eq.P > eq.ATC;
        const rectY = isProfit ? newEqY : newAtcEqY;
        const rectHeight = Math.abs(newAtcEqY - newEqY);
        const fillColor = isProfit ? '#2aa198' : '#d33682';  // cyan for profits, magenta for losses
        const labelText = isProfit ? 'Profits' : 'Losses';

        document.getElementById('profit-rect').setAttribute('y', rectY);
        document.getElementById('profit-rect').setAttribute('width', newEqX - xOrigin);
        document.getElementById('profit-rect').setAttribute('height', rectHeight);
        document.getElementById('profit-rect').setAttribute('fill', fillColor);

        // Update profit/loss label
        document.getElementById('profit-label').textContent = labelText;
        document.getElementById('profit-label').setAttribute('x', xOrigin + (newEqX - xOrigin) / 2);
        document.getElementById('profit-label').setAttribute('y', rectY + rectHeight / 2 + 6);
      }

      // Phase 6: Animate k from 1 to 0.229 (equilibrium reaches Q=120, P=60)
      // At k=0.229: Q*=120, P*=60
      const kFinal = 11/48;  // ≈0.229, gives Q*=120, P*=60
      mainTimeline.to(kAnimState, {
        k: kFinal,
        duration: 2,
        ease: 'none',
        onUpdate: function() {
          updateForK(kAnimState.k);
        }
      }, 5.8);

      // Phase 7: Small delay before unpin
    });
  </script>

</body>
</html>
